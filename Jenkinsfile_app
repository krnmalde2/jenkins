def gv

pipeline {
    tools {
    maven 'Maven'
}
    agent any
    stages {
        stage("init") {
            steps {
                script {

                    gv = load "script2.groovy"
                }
            }
        }

         stage('increment version'){  
         steps {  
            script{  
               echo 'incrementing app version'  
               sh 'mvn build-helper:parse-version versions:set \
               -DnewVersion=\\\${parsedVersion.majorVersion}.\\\${parsedVersion.minorVersion}.\\\${parsedVersion.nextIncrementalVersion}'
               def matcher = readFile('pom.xml') =~ '<version>(.+)</version>'  
               def version = matcher[0][1]  
                echo "version is $version"  
               env.IMAGE_NAME = "$version-$BUILD_NUMBER"  
            }  
         }  
      }  
        stage("build jar") {
            steps {
                script {

                    // echo "building jar"
                    //  sh 'mvn build-helper:parse-version versions:set -DnewVersion=\\\${parsedVersion.nextMajorVersion}.\\\${parsedVersion.minorVersion}.\\\${parsedVersion.incrementalVersion} versions:commit'  
                    //  def match = readFile('pom.xml')=~'<version>(.+)<version>'
                    //  def version= match[0][1]
                    // echo "new version is $version"
                    // env.IMAGE_NAME = "$version-$BUILD_NUMBER"
                    gv.buildJar()
                }
            }
        }
        // stage("build image") {
        //     steps {
        //         script {
        //             echo "building image"
        //             gv.buildImage()
        //         }
        //     }
        // }
        stage("deploy") {
            steps {
                script {
                    echo "deploying"
                    withCredentials([usernamePassword(
                      credentialsId:'dockerhub repo',
                      usernameVariable:'USER',
                      passwordVariable:'PASS'
    )])
    {
                    sh "docker build -t krnmalde/jenkins:${IMAGE_NAME} ."
                    sh "echo $PASS | docker login -u $USER --password-stdin"

    
                    echo "deploy application successfully deployed"
                    sh "docker push krnmalde/jenkins:${IMAGE_NAME}"

    }
                }
            }
        }
    }   
}
